<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personalized Specs — DeskXP</title>
  <meta name="description" content="Pick the services you need, add your details, and I’ll email you a tailored CX plan." />

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    /* Minimal styles copied from your design (kept compact) */
    body { background:#1b272e; color:#e6e9ef; font-family:"Plus Jakarta Sans",sans-serif; margin:0; padding:40px; }
    main { max-width:820px; margin:40px auto; background:#14181d; border-radius:16px; padding:32px; box-shadow:0 10px 30px rgba(0,0,0,.4); }
    h1{ color:#fff; margin:0 0 8px; font-size:1.7rem; }
    .hint{ color:#9aa3ad; margin-bottom:18px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .form-field{ display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
    input,textarea{ padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.25); color:#e6e9ef; }
    textarea{ min-height:100px; resize:vertical; }
    .actions{ display:flex; gap:12px; align-items:center; margin-top:14px; }
    .btn{ padding:10px 16px; border-radius:10px; font-weight:700; cursor:pointer; border:0; }
    .btn-primary{ background:#007236; color:#fff; }
    .btn-ghost{ background:transparent; color:#e6e9ef; border:1px solid rgba(255,255,255,.12); }
    .captcha-wrap{ margin-top:12px; }
    .help{ color:#bfc9cf; display:block; margin-bottom:6px; }
    #formMsg{ color:#ffb3b3; margin-top:8px; display:flex; align-items:center; gap:8px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; font-size:0.9rem; color:#cdd6dd; }
    @media (max-width:600px){ .grid-2{ grid-template-columns:1fr; } .actions{ flex-direction:column; } }
  </style>
</head>
<body>
  <main>
    <h1>Personalized Specs</h1>
    <p class="hint">Choose your scope → share your details → get a custom CX rollout plan.</p>

    <form id="specForm" autocomplete="on" novalidate>
      <!-- Honeypot -->
      <input type="text" id="website" name="website" style="display:none!important" tabindex="-1" autocomplete="off" />

      <!-- Services (simplified) -->
      <div class="form-field">
        <label class="mono">Services (pick any)</label>
        <div style="display:flex;flex-wrap:wrap;gap:8px;">
          <label style="background:rgba(255,255,255,.03);padding:6px 10px;border-radius:999px;"><input type="checkbox" name="services" value="CX End to End management"> CX End to End</label>
          <label style="background:rgba(255,255,255,.03);padding:6px 10px;border-radius:999px;"><input type="checkbox" name="services" value="Zendesk onboarding"> Zendesk onboarding</label>
          <label style="background:rgba(255,255,255,.03);padding:6px 10px;border-radius:999px;"><input type="checkbox" name="services" value="Integration and automation"> Integration</label>
        </div>
      </div>

      <div class="grid-2">
        <div class="form-field">
          <label>Full Name *</label>
          <input id="name" name="name" placeholder="Jane Doe" required>
        </div>
        <div class="form-field">
          <label>Email *</label>
          <input id="email" name="email" type="email" placeholder="you@example.com" required>
        </div>
      </div>

      <div class="form-field">
        <label>Phone</label>
        <input id="phone" name="phone" placeholder="+63 9XX XXX XXXX">
      </div>

      <div class="form-field">
        <label>Project details</label>
        <textarea id="details" name="details" placeholder="Tell me about your project..."></textarea>
      </div>

      <div class="captcha-wrap">
        <small class="help">Quick spam check before sending:</small>
        <!-- Invisible widget container (only one) -->
        <div id="recaptcha" class="g-recaptcha" data-size="invisible"></div>
        <small class="help"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener" style="color:#00b858">Privacy</a> · <a href="https://policies.google.com/terms" target="_blank" rel="noopener" style="color:#00b858">Terms</a></small>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-ghost" id="btnBack" onclick="history.back()">Back</button>
        <button type="button" class="btn btn-primary" id="submitBtn">Send Request</button>
      </div>

      <p id="formMsg" role="status" aria-live="polite"></p>
    </form>
  </main>

  <script>
  // ==== CONFIG ====
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbyjgKsK_Ug0XHWaZHk3KxnjX3UOzsPJ7AdxhlsUjmb-JiN7nbgIj-I2Uq-Cz8kaodxhtg/exec";
  const SECRET   = "deskxp_spec_2025";
  const SITE_KEY_V2 = "6LfDE_ErAAAAABZ3C8_grioLU9BD2CyFtVmhbUXs";

  // ==== DOM ====
  const form = document.getElementById('specForm');
  const submitBtn = document.getElementById('submitBtn');
  const msg = document.getElementById('formMsg');
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  let recaptchaWidgetId = null;

  // Explicit render for Invisible v2
  function onRecaptchaLoad(){
    recaptchaWidgetId = grecaptcha.render('recaptcha', {
      sitekey: SITE_KEY_V2,
      size: 'invisible',
      badge: 'inline',          // avoid overlay being clipped by header
      callback: onCaptchaOK,
      'error-callback': onCaptchaError
    });
  }
  window.onRecaptchaLoad = onRecaptchaLoad;

  // Click -> trigger challenge
  submitBtn.addEventListener('click', (e) => {
    e.preventDefault();
    msg.textContent = "";

    // Honeypot
    if ((document.getElementById('website').value || '').trim() !== '') {
      showSuccess('(bot)','(n/a)');
      return;
    }

    const name  = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    if (!name || !emailRegex.test(email)) { msg.textContent = "❌ Enter a valid name and email."; return; }

    submitBtn.disabled = true;
    submitBtn.textContent = "Verifying…";

    if (typeof grecaptcha !== 'undefined' && recaptchaWidgetId !== null) {
      grecaptcha.execute(recaptchaWidgetId);
    } else {
      msg.textContent = "❌ Captcha not ready. Reload the page.";
      submitBtn.disabled = false; submitBtn.textContent = "Send Request";
    }
  });

  // reCAPTCHA callbacks
  function onCaptchaOK(token){
    if (!token) {
      console.error('reCAPTCHA returned empty token');
      msg.textContent = "❌ Captcha error. Try again.";
      submitBtn.disabled = false; submitBtn.textContent = "Send Request";
      if (recaptchaWidgetId !== null) grecaptcha.reset(recaptchaWidgetId);
      return;
    }
    console.debug('captcha token (first 12):', token.slice(0,12));
    doSubmit(token);
  }
  function onCaptchaError(){
    console.error('reCAPTCHA iframe error (adblock/CSP/network)');
    msg.textContent = "❌ Captcha failed (client). Try again.";
    submitBtn.disabled = false; submitBtn.textContent = "Send Request";
    if (recaptchaWidgetId !== null) grecaptcha.reset(recaptchaWidgetId);
  }

  async function doSubmit(captchaToken){
    msg.textContent = "Sending…";
    submitBtn.textContent = "Sending…";

    const services  = [...document.querySelectorAll('input[name="services"]:checked')].map(i => i.value);
    const team_size = document.querySelector('input[name="team_size"]:checked')?.value || "";
    const name      = document.getElementById('name').value.trim();
    const email     = document.getElementById('email').value.trim();
    const phone     = document.getElementById('phone').value.trim();
    const details   = document.getElementById('details').value.trim();

    const payloadObj = {
      secret: SECRET,
      services, team_size, name, email, phone, details,
      page: location.href, ua: navigator.userAgent,
      // send under BOTH keys (server reads either)
      "g_recaptcha_response": captchaToken,
      "g-recaptcha-response": captchaToken
    };

    try {
      // Send as x-www-form-urlencoded to AVOID CORS preflight
      const res = await fetch(ENDPOINT, {
        method: "POST",
        body: new URLSearchParams({ payload: JSON.stringify(payloadObj) })
      });

      const json = await res.json().catch(()=> ({}));
      if (res.ok && json?.ok) {
        showSuccess(name,email);
      } else {
        console.error('Server said NO:', json);
        msg.textContent = `❌ ${json?.error || "Send failed."} ${json?.codes ? '('+json.codes.join(',')+')' : ''}`;
        submitBtn.disabled = false; submitBtn.textContent = "Send Request";
        if (recaptchaWidgetId !== null) grecaptcha.reset(recaptchaWidgetId);
      }
    } catch (err) {
      console.error('Fetch error:', err);
      msg.textContent = "❌ Network error. Try again.";
      submitBtn.disabled = false; submitBtn.textContent = "Send Request";
      if (recaptchaWidgetId !== null) grecaptcha.reset(recaptchaWidgetId);
    }
  }

  function showSuccess(name,email){
    form.style.display = 'none';
    const s = document.createElement('div');
    s.innerHTML = `<h2 style="color:#00b858">Request received</h2><p>Thanks ${name || 'there'} — we'll get back to you.</p>`;
    document.querySelector('main').appendChild(s);
    document.title = "Request received — DeskXP";
  }
</script>
<script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Finance | DeskXP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #070c11;
      --panel: #121a22;
      --panel-soft: #151f29;
      --accent: #00c26a;
      --accent-soft: rgba(0, 194, 106, 0.14);
      --danger: #ff4b6a;
      --danger-soft: rgba(255, 75, 106, 0.12);
      --border-subtle: rgba(255, 255, 255, 0.06);
      --text: #f5f7fb;
      --muted: #99a2b3;
      --card-radius: 18px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Plus Jakarta Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1b2833 0, #070c11 42%, #020509 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 18px 10px 36px;
    }

    .shell {
      width: 100%;
      max-width: 980px;
      background: radial-gradient(140% 220% at top, rgba(255,255,255,0.08) 0, transparent 45%),
                  linear-gradient(160deg, #111722 0, #050910 45%, #050910 100%);
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow-soft);
      padding: 20px 18px 22px;
    }

    @media (min-width: 640px) {
      .shell { padding: 24px 26px 26px; }
    }

    .shell-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.02em;
    }

    .title-block .sub {
      margin-top: 2px;
      font-size: 13px;
      color: var(--muted);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logout-btn {
      border-radius: 999px;
      padding: 6px 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(4,10,16,0.9);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .logout-btn:hover {
      border-color: rgba(255,255,255,0.3);
      color: var(--text);
    }

    .tabs {
      margin-top: 12px;
      display: inline-flex;
      border-radius: 999px;
      background: rgba(6,12,18,0.8);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 3px;
    }

    .tab {
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 13px;
      border: none;
      color: var(--muted);
      background: transparent;
      cursor: pointer;
      min-width: 84px;
    }

    .tab.active {
      background: linear-gradient(135deg, #009f54, #00c26a);
      color: #050910;
      font-weight: 600;
    }

    .filters-row {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .field {
      flex: 1 1 140px;
      min-width: 0;
    }

    .field label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    select, input[type="date"], input[type="text"], input[type="number"], textarea {
      width: 100%;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(7,11,18,0.95);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      outline: none;
    }

    select:focus, input:focus, textarea:focus {
      border-color: rgba(0,194,106,0.9);
      box-shadow: 0 0 0 1px rgba(0,194,106,0.4);
    }

    .period-nav {
      margin-top: 8px;
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .nav-btn {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(5,9,15,0.9);
      color: var(--muted);
      font-size: 11px;
      padding: 4px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-width: 110px;
      justify-content: center;
    }

    .nav-btn span {
      font-size: 14px;
      line-height: 1;
    }

    .nav-btn:hover {
      border-color: rgba(255,255,255,0.3);
      color: var(--text);
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
      margin-top: 16px;
    }

    @media (min-width: 640px) {
      .grid-3 { gap: 14px; }
    }

    .metric-card {
      background: radial-gradient(circle at top, rgba(255,255,255,0.05) 0, rgba(12,18,24,0.98) 55%);
      border-radius: var(--card-radius);
      padding: 12px 14px;
      border: 1px solid var(--border-subtle);
      min-height: 68px;
    }

    .metric-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 16px;
      font-weight: 600;
    }

    .metric-value.positive {
      color: var(--accent);
    }

    .metric-value.negative {
      color: var(--danger);
    }

    .section-title {
      margin: 20px 0 6px;
      font-size: 13px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .chart-container {
      background: var(--panel-soft);
      border-radius: var(--card-radius);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 12px 10px 8px;
    }

    @media (min-width: 640px) {
      .chart-container { padding: 16px 16px 12px; }
    }

    canvas {
      width: 100% !important;
      height: 260px !important;
    }

    .ytd-grid {
      display: grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: 10px;
      margin-top: 14px;
    }

    .ytd-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .actions-row {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn {
      flex: 1 1 150px;
      border-radius: 999px;
      padding: 11px 14px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-income {
      background: linear-gradient(135deg, #00b55e, #00d06e);
      color: #020607;
    }

    .btn-expense {
      background: linear-gradient(135deg, #ff4b6a, #ff7a5c);
      color: #020607;
    }

    .btn:active {
      transform: translateY(1px);
      opacity: 0.96;
    }

    .tab-page {
      margin-top: 8px;
    }

    .tab-page.hidden {
      display: none;
    }

    .details-section {
      margin-top: 16px;
    }

    .table-title {
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 6px;
      margin-top: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      border-radius: 16px;
      overflow: hidden;
      background: rgba(4,10,16,0.9);
      border: 1px solid rgba(255,255,255,0.06);
    }

    thead {
      background: rgba(10,18,26,1);
    }

    th, td {
      padding: 7px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    th {
      font-weight: 600;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    tbody tr {
      cursor: pointer;
    }

    tbody tr:nth-child(even) {
      background: rgba(255,255,255,0.01);
    }

    tbody tr:hover {
      background: rgba(0,194,106,0.06);
    }

    .amount-cell {
      text-align: right;
      white-space: nowrap;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }
    .status-paid {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .status-unpaid {
      background: var(--danger-soft);
      color: var(--danger);
    }

    .details-pie {
      margin-top: 16px;
    }
    .details-pie.hidden {
      display: none;
    }

    #expensePie {
      width: 220px !important;
      height: 220px !important;
      margin: 0 auto;
      display: block;
    }

    #expensePieSummary {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }
    #expensePieSummary strong {
      font-weight: 600;
      color: var(--text);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }
    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      background: radial-gradient(circle at top, rgba(255,255,255,0.08) 0, rgba(9,12,19,1) 55%);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-soft);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
    }

    .modal-close {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: var(--muted);
      padding: 2px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .modal-body .field {
      margin-bottom: 10px;
    }

    .modal-body select,
    .modal-body input,
    .modal-body textarea {
      border-radius: 12px;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .modal-footer {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-primary {
      flex: 1;
      border-radius: 999px;
      padding: 9px 0;
      border: none;
      background: linear-gradient(135deg, #00b55e,#00d06e);
      color: #020607;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-secondary {
      flex: 1;
      border-radius: 999px;
      padding: 9px 0;
      border: 1px solid rgba(255,255,255,0.25);
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
    }

    .btn-danger {
      flex: 0 0 auto;
      border-radius: 999px;
      padding: 9px 14px;
      border: none;
      background: var(--danger);
      color: #020607;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }

    .empty-note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    @media (max-width: 480px) {
      .metric-card {
        padding: 10px 10px;
      }
      .metric-value {
        font-size: 14px;
      }
    }

    .modal-body input[type="date"] {
      -webkit-appearance: none;
      appearance: none;
      font-size: 14px;
      padding: 10px 12px;
    }

    @media (max-width: 480px) {
      .modal {
        padding: 16px 14px 14px;
      }

      .modal-body input[type="date"] {
        font-size: 13px;
        padding: 9px 10px;
      }
    }

    /* Sub-items UI */
    #subItemsContainer {
      border-radius: 14px;
      padding: 8px 10px 6px;
      background: rgba(8, 14, 20, 0.96);
      border: 1px solid rgba(255,255,255,0.08);
    }

    #subItemsContainer label {
      margin-bottom: 6px;
    }

    .subitem-row {
      display: grid;
      grid-template-columns: 2fr 1.1fr;
      gap: 6px;
      margin-bottom: 6px;
    }

    .subitem-row input[type="text"],
    .subitem-row input[type="number"] {
      border-radius: 999px;
      font-size: 12px;
      padding: 7px 10px;
    }

    .subitem-add-btn {
      margin-top: 2px;
      border-radius: 999px;
      border: 1px dashed rgba(255,255,255,0.25);
      background: transparent;
      color: var(--muted);
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .subitem-add-btn span {
      font-size: 14px;
      line-height: 1;
    }

    .subitem-total {
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="shell-header">
      <div class="title-block">
        <h1>Finance</h1>
        <div class="sub" id="currentPeriodLabel">Loading…</div>
      </div>
      <div class="top-actions">
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabSummary">Summary</button>
      <button class="tab" id="tabDetails">Details</button>
    </div>

    <div class="details-pie hidden" id="detailsPieWrapper">
      <div class="section-title">Expenses breakdown</div>
      <div class="chart-container">
        <canvas id="expensePie"></canvas>
      </div>
      <div id="expensePieSummary"></div>
    </div>

    <div class="filters-row">
      <div class="field">
        <label>Month</label>
        <select id="monthSelect"></select>
      </div>
      <div class="field">
        <label>Year</label>
        <select id="yearSelect"></select>
      </div>
    </div>

    <div class="period-nav">
      <button class="nav-btn" id="prevPeriodBtn">
        <span>←</span>
        <span>Previous</span>
      </button>
      <button class="nav-btn" id="nextPeriodBtn">
        <span>Next</span>
        <span>→</span>
      </button>
    </div>

    <div class="tab-page" id="pageSummary">
      <div class="grid-3">
        <div class="metric-card">
          <div class="metric-label">Month income</div>
          <div class="metric-value" id="monthIncome">₱0.00</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Month expense</div>
          <div class="metric-value" id="monthExpense">₱0.00</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Month net</div>
          <div class="metric-value positive" id="monthNet">₱0.00</div>
        </div>
      </div>

      <div class="section-title">Income vs Expense (past 9 months + next 3)</div>
      <div class="chart-container">
        <canvas id="trendChart"></canvas>
      </div>

      <div class="section-title">Year-to-date</div>
      <div class="ytd-grid">
        <div class="metric-card">
          <div class="metric-label">Year income (YTD)</div>
          <div class="metric-value" id="yearIncome">₱0.00</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Year expense (YTD)</div>
          <div class="metric-value" id="yearExpense">₱0.00</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Year net (YTD)</div>
          <div class="metric-value positive" id="yearNet">₱0.00</div>
        </div>
      </div>
      <div class="ytd-note" id="ytdNote"></div>

      <div class="actions-row">
        <button class="btn btn-income" id="btnAddIncome">Add income</button>
        <button class="btn btn-expense" id="btnAddExpense">Add expense</button>
      </div>
    </div>

    <div class="tab-page hidden" id="pageDetails">
      <div class="details-section">
        <div class="table-title">Income</div>
        <table>
          <thead>
            <tr>
              <th style="width: 30%;">Date</th>
              <th>Source</th>
              <th style="width: 25%; text-align:right;">Amount</th>
            </tr>
          </thead>
          <tbody id="incomeTableBody"></tbody>
        </table>
        <div class="empty-note" id="incomeEmpty"></div>
      </div>

      <div class="details-section">
        <div class="table-title">Expenses</div>
        <table>
          <thead>
            <tr>
              <th style="width: 26%;">Date</th>
              <th>Item</th>
              <th style="width: 18%;">Status</th>
              <th style="width: 25%; text-align:right;">Amount</th>
            </tr>
          </thead>
          <tbody id="expenseTableBody"></tbody>
        </table>
        <div class="empty-note" id="expenseEmpty"></div>
      </div>

      <div class="actions-row">
        <button class="btn btn-income" id="btnAddIncomeDetails">Add income</button>
        <button class="btn btn-expense" id="btnAddExpenseDetails">Add expense</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Add transaction</div>
        <button class="modal-close" id="modalCloseBtn">Close</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Date</label>
          <input type="date" id="txDate" />
        </div>
        <div class="field">
          <label id="labelLabel">Source / Item</label>
          <input type="text" id="txLabel" />
        </div>
        <div class="field">
          <label>Amount</label>
          <input type="number" id="txAmount" step="0.01" min="0" />
        </div>
        <div class="field" id="subItemsContainer" style="display:none;">
          <label>Sub items</label>
          <div id="subItemsList"></div>
          <button type="button" class="subitem-add-btn" id="btnAddSubItem">
            <span>＋</span>
            <span>Add sub item</span>
          </button>
          <div class="subitem-total" id="subItemsTotal"></div>
        </div>
        <div class="field" id="statusField">
          <label>Status</label>
          <select id="txStatus">
            <option value="paid">Paid</option>
            <option value="unpaid">Unpaid</option>
          </select>
        </div>
        <div class="field">
          <label>Note</label>
          <textarea id="txNote"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-danger" id="btnDeleteTx" style="display:none;">Delete</button>
        <button class="btn-secondary" id="btnCancelTx">Cancel</button>
        <button class="btn-primary" id="btnSaveTx">Save</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://fgtakqdkovomrivljzin.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZndGFrcWRrb3ZvbXJpdmxqemluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjAwNjMsImV4cCI6MjA3OTkzNjA2M30.fDVT3jzMkpNTNxLgq7hc-c9OCrvPZW_qB_RV_XFTxFU';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let allTransactions = [];
    let trendChart = null;
    let expensePieChart = null;

    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');

    const monthIncomeEl = document.getElementById('monthIncome');
    const monthExpenseEl = document.getElementById('monthExpense');
    const monthNetEl = document.getElementById('monthNet');

    const yearIncomeEl = document.getElementById('yearIncome');
    const yearExpenseEl = document.getElementById('yearExpense');
    const yearNetEl = document.getElementById('yearNet');
    const ytdNoteEl = document.getElementById('ytdNote');

    const currentPeriodLabel = document.getElementById('currentPeriodLabel');

    const incomeTableBody = document.getElementById('incomeTableBody');
    const expenseTableBody = document.getElementById('expenseTableBody');
    const incomeEmpty = document.getElementById('incomeEmpty');
    const expenseEmpty = document.getElementById('expenseEmpty');

    const tabSummary = document.getElementById('tabSummary');
    const tabDetails = document.getElementById('tabDetails');
    const pageSummary = document.getElementById('pageSummary');
    const pageDetails = document.getElementById('pageDetails');

    const detailsPieWrapper = document.getElementById('detailsPieWrapper');
    const expensePieSummary = document.getElementById('expensePieSummary');

    const btnAddIncome = document.getElementById('btnAddIncome');
    const btnAddExpense = document.getElementById('btnAddExpense');
    const btnAddIncomeDetails = document.getElementById('btnAddIncomeDetails');
    const btnAddExpenseDetails = document.getElementById('btnAddExpenseDetails');
    const logoutBtn = document.getElementById('logoutBtn');

    const prevPeriodBtn = document.getElementById('prevPeriodBtn');
    const nextPeriodBtn = document.getElementById('nextPeriodBtn');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const btnCancelTx = document.getElementById('btnCancelTx');
    const btnSaveTx = document.getElementById('btnSaveTx');
    const btnDeleteTx = document.getElementById('btnDeleteTx');

    const txDate = document.getElementById('txDate');
    const txLabel = document.getElementById('txLabel');
    const txAmount = document.getElementById('txAmount');
    const txStatus = document.getElementById('txStatus');
    const txNote = document.getElementById('txNote');
    const statusField = document.getElementById('statusField');
    const labelLabel = document.getElementById('labelLabel');

    const subItemsContainer = document.getElementById('subItemsContainer');
    const subItemsList = document.getElementById('subItemsList');
    const subItemsTotal = document.getElementById('subItemsTotal');
    const btnAddSubItem = document.getElementById('btnAddSubItem');

    let modalMode = 'income';
    let editingId = null;

    const centerTextPlugin = {
      id: 'centerText',
      beforeDraw(chart, args, pluginOptions) {
        const lines = pluginOptions && pluginOptions.lines;
        if (!lines || !lines.length) return;
        const { ctx } = chart;
        const meta = chart.getDatasetMeta(0);
        if (!meta.data || !meta.data.length) return;
        const centerX = meta.data[0].x;
        const centerY = meta.data[0].y;

        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#f5f7fb';
        const lineHeight = 16;
        const totalHeight = lineHeight * (lines.length - 1);

        lines.forEach((line, index) => {
          ctx.font = (index === 0)
            ? '600 14px "Plus Jakarta Sans", system-ui'
            : '400 11px "Plus Jakarta Sans", system-ui';
          ctx.fillText(
            line,
            centerX,
            centerY - totalHeight / 2 + index * lineHeight
          );
        });

        ctx.restore();
      }
    };

    Chart.register(centerTextPlugin);

    async function requireAuth() {
      const { data, error } = await db.auth.getSession();
      if (error) {
        console.error('Error getting session', error);
        window.location.href = '/login.html';
        return;
      }
      if (!data.session) {
        window.location.href = '/login.html';
        return;
      }
      currentUser = data.session.user;
    }

    logoutBtn.addEventListener('click', async () => {
      await db.auth.signOut();
      window.location.href = '/login.html';
    });

    function formatCurrency(n) {
      const num = typeof n === 'number' ? n : Number(String(n || '0').replace(/,/g,''));
      return '₱' + num.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function dateToParts(iso) {
      const d = new Date(iso);
      return {
        y: d.getFullYear(),
        m: d.getMonth(),
        label: d.toLocaleDateString('en-PH', { month: 'short', day: '2-digit' })
      };
    }

    function getSelectedYear() {
      return Number(yearSelect.value);
    }
    function getSelectedMonthIndex() {
      return Number(monthSelect.value);
    }

    function shiftPeriod(deltaMonths) {
      let m = getSelectedMonthIndex();
      let y = getSelectedYear();

      m += deltaMonths;

      while (m < 0) {
        m += 12;
        y -= 1;
      }
      while (m > 11) {
        m -= 12;
        y += 1;
      }

      const existingYears = Array.from(yearSelect.options).map(o => Number(o.value));
      if (!existingYears.includes(y)) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      }

      monthSelect.value = String(m);
      yearSelect.value = String(y);

      recomputeAndRender();
    }

    async function loadTransactions() {
      const { data, error } = await db
        .from('transactions')
        .select('*')
        .order('date', { ascending: true });

      if (error) {
        console.error('Error loading transactions', error);
        return;
      }
      allTransactions = data || [];
      recomputeAndRender();
    }

    function recomputeAndRender() {
      const year = getSelectedYear();
      const monthIdx = getSelectedMonthIndex();

      currentPeriodLabel.textContent = `${monthNames[monthIdx]} ${year}`;

      const monthIncomeTx = [];
      const monthExpenseTx = [];
      const yearIncomeTx = [];
      const yearExpenseTx = [];

      for (const t of allTransactions) {
        if (!t.date) continue;
        const d = new Date(t.date);
        const y = d.getFullYear();
        const m = d.getMonth();
        const amount = typeof t.amount === 'number'
          ? t.amount
          : Number(String(t.amount || '0').replace(/,/g,''));

        if (y === year) {
          if (t.type === 'income') yearIncomeTx.push({ ...t, _amt: amount });
          if (t.type === 'expense') yearExpenseTx.push({ ...t, _amt: amount });
        }

        if (y === year && m === monthIdx) {
          if (t.type === 'income') monthIncomeTx.push({ ...t, _amt: amount });
          if (t.type === 'expense') monthExpenseTx.push({ ...t, _amt: amount });
        }
      }

      const monthIncomeTotal = monthIncomeTx.reduce((s,t)=>s + t._amt, 0);
      const monthExpenseTotal = monthExpenseTx.reduce((s,t)=>s + t._amt, 0);
      const monthNetTotal = monthIncomeTotal - monthExpenseTotal;

      const yearIncomeTotal = yearIncomeTx.reduce((s,t)=>s + t._amt, 0);
      const yearExpenseTotal = yearExpenseTx.reduce((s,t)=>s + t._amt, 0);
      const yearNetTotal = yearIncomeTotal - yearExpenseTotal;

      monthIncomeEl.textContent = formatCurrency(monthIncomeTotal);
      monthExpenseEl.textContent = formatCurrency(monthExpenseTotal);
      monthNetEl.textContent = formatCurrency(monthNetTotal);
      monthNetEl.classList.toggle('positive', monthNetTotal >= 0);
      monthNetEl.classList.toggle('negative', monthNetTotal < 0);

      yearIncomeEl.textContent = formatCurrency(yearIncomeTotal);
      yearExpenseEl.textContent = formatCurrency(yearExpenseTotal);
      yearNetEl.textContent = formatCurrency(yearNetTotal);
      yearNetEl.classList.toggle('positive', yearNetTotal >= 0);
      yearNetEl.classList.toggle('negative', yearNetTotal < 0);
      ytdNoteEl.textContent = `Year-to-date for ${year} (through December).`;

      let paidTotal = 0;
      let unpaidTotal = 0;
      for (const t of monthExpenseTx) {
        const status = (t.status || 'paid').toLowerCase();
        if (status === 'unpaid') {
          unpaidTotal += t._amt;
        } else {
          paidTotal += t._amt;
        }
      }
      renderExpensePie(paidTotal, unpaidTotal);

      renderChart(year, monthIdx);
      renderDetailsTables(monthIncomeTx, monthExpenseTx);
    }

    function renderChart(year, monthIdx) {
      const labels = [];
      const incomeData = [];
      const expenseData = [];

      for (let offset = -9; offset <= 3; offset++) {
        const d = new Date(year, monthIdx + offset, 1);
        const y = d.getFullYear();
        const m = d.getMonth();

        labels.push(
          d.toLocaleDateString('en-PH', { month: 'short', year: '2-digit' })
        );

        const monthIncome = allTransactions
          .filter(t => t.type === 'income' && t.date && (new Date(t.date)).getFullYear() === y && (new Date(t.date)).getMonth() === m)
          .reduce((s,t)=>{
            const amt = typeof t.amount === 'number'
              ? t.amount
              : Number(String(t.amount || '0').replace(/,/g,''));
            return s + amt;
          },0);

        const monthExpense = allTransactions
          .filter(t => t.type === 'expense' && t.date && (new Date(t.date)).getFullYear() === y && (new Date(t.date)).getMonth() === m)
          .reduce((s,t)=>{
            const amt = typeof t.amount === 'number'
              ? t.amount
              : Number(String(t.amount || '0').replace(/,/g,''));
            return s + amt;
          },0);

        incomeData.push(monthIncome);
        expenseData.push(monthExpense);
      }

      const maxVal = Math.max(...incomeData, ...expenseData, 0);
      const suggestedMax = maxVal > 0 ? maxVal * 1.15 : 1;

      const ctx = document.getElementById('trendChart').getContext('2d');
      if (trendChart) {
        trendChart.destroy();
      }
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Income',
              data: incomeData,
              borderColor: '#32d583',
              backgroundColor: 'rgba(50,213,131,0.12)',
              tension: 0.3,
              pointRadius: 3,
              pointHoverRadius: 4,
              borderWidth: 2
            },
            {
              label: 'Expense',
              data: expenseData,
              borderColor: '#ff6b81',
              backgroundColor: 'rgba(255,107,129,0.12)',
              tension: 0.3,
              pointRadius: 3,
              pointHoverRadius: 4,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: { top: 10, right: 10, bottom: 8, left: 4 }
          },
          scales: {
            x: {
              ticks: { color: '#9ba5b8', maxRotation: 45, minRotation: 45 },
              grid: { display: false }
            },
            y: {
              suggestedMax,
              ticks: {
                color: '#9ba5b8',
                callback: (value) => value.toLocaleString('en-PH')
              },
              grid: { color: 'rgba(255,255,255,0.05)' }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: '#c2cad8',
                usePointStyle: false,
                boxWidth: 40,
                boxHeight: 2
              },
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}`
              }
            }
          }
        }
      });
    }

    function renderExpensePie(paid, unpaid) {
      if (!detailsPieWrapper) return;

      const total = paid + unpaid;

      if (total <= 0) {
        if (expensePieChart) {
          expensePieChart.destroy();
          expensePieChart = null;
        }
        expensePieSummary.textContent = 'No expenses with status for this month.';
        return;
      }

      const ctx = document.getElementById('expensePie').getContext('2d');
      if (expensePieChart) {
        expensePieChart.destroy();
      }

      expensePieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Paid', 'Unpaid'],
          datasets: [{
            data: [paid, unpaid],
            backgroundColor: ['#32d583', '#ff6b81'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#c2cad8'
              }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const val = ctx.parsed;
                  const pct = ((val / total) * 100).toFixed(1);
                  return `${ctx.label}: ${formatCurrency(val)} (${pct}%)`;
                }
              }
            },
            centerText: {
              lines: [
                formatCurrency(total),
                'Total expenses'
              ]
            }
          }
        }
      });

      const paidPct = ((paid / total) * 100).toFixed(1);
      const unpaidPct = ((unpaid / total) * 100).toFixed(1);

      expensePieSummary.innerHTML =
        `Paid: <strong>${formatCurrency(paid)}</strong> (${paidPct}%) · ` +
        `Unpaid: <strong>${formatCurrency(unpaid)}</strong> (${unpaidPct}%)`;
    }

    function renderDetailsTables(monthIncomeTx, monthExpenseTx) {
      incomeTableBody.innerHTML = '';
      expenseTableBody.innerHTML = '';

      if (monthIncomeTx.length === 0) {
        incomeEmpty.textContent = 'No income entries for this month.';
      } else {
        incomeEmpty.textContent = '';
      }
      if (monthExpenseTx.length === 0) {
        expenseEmpty.textContent = 'No expense entries for this month.';
      } else {
        expenseEmpty.textContent = '';
      }

      monthIncomeTx
        .sort((a,b)=>new Date(a.date) - new Date(b.date))
        .forEach(t => {
          const tr = document.createElement('tr');
          const { label: dateLabel } = dateToParts(t.date);
          tr.innerHTML = `
            <td>${dateLabel}</td>
            <td>${t.label || ''}</td>
            <td class="amount-cell">${formatCurrency(t._amt)}</td>
          `;
          tr.dataset.id = t.id;
          tr.dataset.type = 'income';
          incomeTableBody.appendChild(tr);
        });

      monthExpenseTx
        .sort((a,b)=>new Date(a.date) - new Date(b.date))
        .forEach(t => {
          const tr = document.createElement('tr');
          const { label: dateLabel } = dateToParts(t.date);
          const status = (t.status || '').toLowerCase();
          const pillClass = status === 'paid' ? 'status-paid' : status === 'unpaid' ? 'status-unpaid' : '';
          const pillLabel = status ? status.charAt(0).toUpperCase() + status.slice(1) : '';
          tr.innerHTML = `
            <td>${dateLabel}</td>
            <td>${t.label || ''}</td>
            <td>${status ? `<span class="status-pill ${pillClass}">${pillLabel}</span>` : ''}</td>
            <td class="amount-cell">${formatCurrency(t._amt)}</td>
          `;
          tr.dataset.id = t.id;
          tr.dataset.type = 'expense';
          expenseTableBody.appendChild(tr);
        });

      incomeTableBody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('click', () => {
          const id = row.dataset.id;
          const tx = allTransactions.find(t => t.id === id);
          if (tx) openEditModal(tx);
        });
      });

      expenseTableBody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('click', () => {
          const id = row.dataset.id;
          const tx = allTransactions.find(t => t.id === id);
          if (tx) openEditModal(tx);
        });
      });
    }

    function resetSubItems() {
      if (!subItemsList) return;
      subItemsList.innerHTML = '';
      if (subItemsTotal) subItemsTotal.textContent = '';
    }

    function addSubItemRow(initial) {
      const row = document.createElement('div');
      row.className = 'subitem-row';
      const labelVal = initial && initial.label ? initial.label : '';
      const amountVal = initial && typeof initial.amount !== 'undefined' ? initial.amount : '';

      row.innerHTML = `
        <input type="text" class="subitem-label" placeholder="Sub item" value="${labelVal}">
        <input type="number" class="subitem-amount" step="0.01" min="0" placeholder="0.00" value="${amountVal}">
      `;

      const amountInput = row.querySelector('.subitem-amount');
      const labelInput = row.querySelector('.subitem-label');
      amountInput.addEventListener('input', recalculateSubItemsTotal);
      labelInput.addEventListener('input', recalculateSubItemsTotal);

      subItemsList.appendChild(row);
      recalculateSubItemsTotal();
    }

    function recalculateSubItemsTotal() {
      if (!subItemsList) return;
      const rows = subItemsList.querySelectorAll('.subitem-row');
      let total = 0;
      let hasAny = false;

      rows.forEach(row => {
        const labelInput = row.querySelector('.subitem-label');
        const amountInput = row.querySelector('.subitem-amount');
        const label = labelInput.value.trim();
        const amount = Number(amountInput.value || 0);
        if (label || amount) {
          hasAny = true;
        }
        if (!Number.isNaN(amount)) {
          total += amount;
        }
      });

      if (subItemsTotal) {
        if (hasAny) {
          subItemsTotal.textContent = `Total of sub items: ${formatCurrency(total)}`;
        } else {
          subItemsTotal.textContent = '';
        }
      }

      if (hasAny && txAmount) {
        txAmount.value = total.toFixed(2);
      }
    }

    if (btnAddSubItem) {
      btnAddSubItem.addEventListener('click', () => {
        addSubItemRow();
      });
    }

    function openAddModal(type) {
      modalMode = type;
      editingId = null;

      modalTitle.textContent = type === 'income' ? 'Add income' : 'Add expense';
      labelLabel.textContent = type === 'income' ? 'Source' : 'Item';
      statusField.style.display = type === 'expense' ? 'block' : 'none';
      btnDeleteTx.style.display = 'none';

      const today = new Date();
      const isoToday = today.toISOString().slice(0,10);
      txDate.value = isoToday;

      txLabel.value = '';
      txAmount.value = '';
      txStatus.value = 'paid';
      txNote.value = '';

      if (type === 'expense') {
        subItemsContainer.style.display = 'block';
        resetSubItems();
      } else {
        subItemsContainer.style.display = 'none';
        resetSubItems();
      }

      modalBackdrop.classList.add('show');
    }

    function openEditModal(tx) {
      modalMode = tx.type;
      editingId = tx.id;

      modalTitle.textContent = tx.type === 'income' ? 'Edit income' : 'Edit expense';
      labelLabel.textContent = tx.type === 'income' ? 'Source' : 'Item';
      statusField.style.display = tx.type === 'expense' ? 'block' : 'none';
      btnDeleteTx.style.display = 'inline-flex';

      txDate.value = tx.date ? String(tx.date).slice(0,10) : '';
      txLabel.value = tx.label || '';
      txAmount.value = typeof tx.amount === 'number'
        ? tx.amount
        : Number(String(tx.amount || '0').replace(/,/g,''));
      txStatus.value = (tx.status || 'paid').toLowerCase();
      txNote.value = tx.note || '';

      if (tx.type === 'expense') {
        subItemsContainer.style.display = 'block';
        resetSubItems();

        let items = [];
        if (tx.sub_items) {
          if (typeof tx.sub_items === 'string') {
            try {
              items = JSON.parse(tx.sub_items);
            } catch (e) {
              items = [];
            }
          } else if (Array.isArray(tx.sub_items)) {
            items = tx.sub_items;
          }
        }
        if (items.length) {
          items.forEach(it => addSubItemRow(it));
        } else {
          recalculateSubItemsTotal();
        }
      } else {
        subItemsContainer.style.display = 'none';
        resetSubItems();
      }

      modalBackdrop.classList.add('show');
    }

    function closeModal() {
      modalBackdrop.classList.remove('show');
    }

    modalCloseBtn.addEventListener('click', closeModal);
    btnCancelTx.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    btnSaveTx.addEventListener('click', async () => {
      const dateVal = txDate.value;
      const labelVal = txLabel.value.trim();
      const amountVal = Number(txAmount.value || 0);
      const statusVal = txStatus.value;
      const noteVal = txNote.value.trim();

      if (!dateVal || !labelVal || !amountVal) {
        alert('Date, label, and amount are required.');
        return;
      }

      let subItems = null;
      if (modalMode === 'expense' && subItemsList) {
        const rows = subItemsList.querySelectorAll('.subitem-row');
        const arr = [];
        rows.forEach(row => {
          const labelInput = row.querySelector('.subitem-label');
          const amountInput = row.querySelector('.subitem-amount');
          const subLabel = labelInput.value.trim();
          const subAmount = Number(amountInput.value || 0);
          if (subLabel || subAmount) {
            arr.push({ label: subLabel, amount: subAmount });
          }
        });
        if (arr.length) {
          subItems = arr;
        }
      }

      const payload = {
        type: modalMode,
        date: dateVal,
        label: labelVal,
        amount: amountVal,
        status: modalMode === 'expense' ? statusVal : null,
        note: noteVal || null,
        sub_items: modalMode === 'expense' ? (subItems || null) : null
      };

      try {
        if (editingId) {
          const { error } = await db
            .from('transactions')
            .update(payload)
            .eq('id', editingId);
          if (error) throw error;
        } else {
          const { error } = await db
            .from('transactions')
            .insert(payload);
          if (error) throw error;
        }
        closeModal();
        await loadTransactions();
      } catch (err) {
        console.error('Save error', err);
        alert('Failed to save transaction.');
      }
    });

    btnDeleteTx.addEventListener('click', async () => {
      if (!editingId) return;
      if (!confirm('Delete this transaction?')) return;
      try {
        const { error } = await db
          .from('transactions')
          .delete()
          .eq('id', editingId);
        if (error) throw error;
        closeModal();
        await loadTransactions();
      } catch (err) {
        console.error('Delete error', err);
        alert('Failed to delete transaction.');
      }
    });

    tabSummary.addEventListener('click', () => {
      tabSummary.classList.add('active');
      tabDetails.classList.remove('active');
      pageSummary.classList.remove('hidden');
      pageDetails.classList.add('hidden');
      detailsPieWrapper.classList.add('hidden');
    });

    tabDetails.addEventListener('click', () => {
      tabDetails.classList.add('active');
      tabSummary.classList.remove('active');
      pageDetails.classList.remove('hidden');
      pageSummary.classList.add('hidden');
      detailsPieWrapper.classList.remove('hidden');
    });

    monthSelect.addEventListener('change', recomputeAndRender);
    yearSelect.addEventListener('change', recomputeAndRender);

    btnAddIncome.addEventListener('click', () => openAddModal('income'));
    btnAddExpense.addEventListener('click', () => openAddModal('expense'));
    btnAddIncomeDetails.addEventListener('click', () => openAddModal('income'));
    btnAddExpenseDetails.addEventListener('click', () => openAddModal('expense'));

    prevPeriodBtn.addEventListener('click', () => shiftPeriod(-1));
    nextPeriodBtn.addEventListener('click', () => shiftPeriod(1));

    (async function init() {
      await requireAuth();

      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();

      monthNames.forEach((name, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = name;
        if (idx === currentMonth) opt.selected = true;
        monthSelect.appendChild(opt);
      });

      const minYear = currentYear - 2;
      const maxYear = currentYear + 2;
      for (let y = minYear; y <= maxYear; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }

      await loadTransactions();
    })();
  </script>
</body>
</html>
